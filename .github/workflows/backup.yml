name: Weekly MongoDB Backup

on:
  schedule:
    - cron: '0 3 * * 0' # Ogni Domenica alle 03:00 UTC
  workflow_dispatch: # Permette di lanciarlo anche a mano

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install MongoDB Tools
        run: |
          wget -q https://fastdl.mongodb.org/tools/db/mongodb-database-tools-ubuntu-x86_64-100.9.4.tgz
          tar -xzf mongodb-database-tools-*.tgz
          sudo cp mongodb-database-tools-*/bin/mongodump /usr/local/bin/

      - name: Create Backup
        env:
          # Qui usa la "Secret" che avevamo impostato, o puoi scriverla diretta se il repo Ã¨ privato
          MONGO_URI: ${{ secrets.MONGODB_URI }}
        run: |
          mongodump --uri="$MONGO_URI" --archive=backup_$(date +%Y%m%d).gz --gzip

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mongodb-backup-${{ github.run_id }}
          path: backup_*.gz
          retention-days: 90
